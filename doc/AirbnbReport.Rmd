---
title: "AirbnbReport"
author: BDA Group
date: "6 February 2016"
output: html_document
---

Airbnb Booking Analysis
==========================================

**BDA** - *INSEAD MBA 16J*


 
## Business motivation

Understanding customers' dynamics and behaviour is essential for digital companies, especially for those whose business model is based on purchases or reservations from customers. 

In the case of a company such as Airbnb, where customers rent rooms or apartments from other users, it is key to understand what drives customers to make the final reservation. If the company manages to understand the patterns, and has a systematic process to analyze the behaviour, it will be able to implement actions to improve the booking ratio, as well as to assess the success of the actions. 

For this case, we have selected a public shared file with data from customers, and we will guide you through the different data that the file contains, and the different measures that we find interesting in order to analyze customers' behaviour. 


It is very important to understand the columns, let's review its content:

* **id_visitor**: the id of the visitor
* **id_session**: the id of the session
* **dim_session_number**: the number of session on a given day for a visitor
* **dim_user_agent**: the user agent of the session
* **dim_device_app_combo**: the parsed out device/app combo from user agent
* **ds**: date stamp of session
* **ts_min**: time of session start
* **ts_max**: time of session end
* **did_search**: binary flag indicating if the visitor performed a search during the session
* **sent_message**: binary flag indicating if the visitor sent a message during the session
* **sent_booking_request**: binary flag indicating if the visitor sent a booking request during the session


<br>
##ANA


```{r, echo=FALSE, message=FALSE, prompt=FALSE, results='asis'}
library(googleVis)
library(dplyr)
local_directory <- getwd()
ProjectData <- read.csv("../data/Airbnb_data1.csv", sep=",", dec=".") # this contains only the matrix ProjectData
t1 <- gvisTable(ProjectData[1:100,],options = list(showRowNumber = FALSE, width = 800, height = min(400,27*(nrow(ProjectData) + 1)), allowHTML = TRUE, page = 'disable'))
print(t1,'chart')
```

# Conversion rates

Let's have a look at the conversion rates for the users. We are going to analyze in this case several ratios, such as:
- the percentage of visits that end in bookings
- the percentage of times that users send a message to the owner
- the perc. of times that a booking is realized after a message has been sent

Before any other analysis, let's look at these ratios for the global set of customers (without considering the number of session or other parameters):

```{r, echo=TRUE, message=FALSE, prompt=FALSE, results='asis'}
int1 <- ProjectData[ProjectData$sent_booking_request == 1,]
int2 <- select(int1, totalbookings = sum(sent_booking_request))
int3 <- summarise(int2, percbookings = sum(totalbookings)*100/nrow(ProjectData))
numbookings <- paste(round(int3$percbookings, digits = 2), "%", sep="")

int4 <- ProjectData[ProjectData$sent_message == 1,]
int5 <- select(int4, totalmessages = sum(sent_message))
int6 <- summarise(int5, percmessage = sum(totalmessages)*100/nrow(ProjectData))
nummessages <- paste(round(int6$percmessage, digits = 2), "%", sep="")

int7 <- int4[int4$sent_booking_request == 1,]
int8 <- select(int7, subbookings = sum(sent_booking_request))
int9 <- summarise(int8, percmessage = sum(subbookings)*100/nrow(int4))
numbookings2 <- paste(round(int9$percmessage, digits = 2), "%", sep="")
```

**Summary**

- Percentage of visits that end in bookings: `r numbookings`

- Percentage of times user send a message: `r nummessages`

- Percentage of times user booked after a message: `r numbookings2`

<br>
As we can see, for every 100 visits to Airbnb, only less than 2 end up in a booking. Although we can't conclude whether this figure is high or low, it will be interesting to keep a record of how this percentage change along time, and whether it changes with specific actions Airbnb takes in marketing.
<br>
On the other hand, if we check the success ratio after sending a message, we can see it is much higher than without a message (for every 100 messages sent, over 8 bookings were realized). It would be useful to have more data about what it is that drives the customers to send messages. 
<br>
If Airbnb could gather the information about why customers send messages, it could develop more targeted campaigns, and could track whether the ratio of messages vs visits increases, and/or whether the ratio of bookings vs messages increases.

<br>

## Data Description
##Dominik
start lubridate

```{r, echo=FALSE, message=FALSE, prompt=FALSE, results='asis'}
airbnbData = read.csv(paste(local_directory,"../data/Airbnb_data1.csv", sep="/"), header=TRUE, sep=",", dec=".")


airbnbData[,"ts_min_calc"]=dmy_hm(airbnbData[,which(colnames(airbnbData)=="ts_min")])
airbnbData[,"ts_max_calc"]=dmy_hm(airbnbData[,which(colnames(airbnbData)=="ts_max")])
airbnbData[,"ts_diff"]=difftime(airbnbData[,which(colnames(airbnbData)=="ts_max_calc")],airbnbData[,which(colnames(airbnbData)=="ts_min_calc")])
airbnbData[,"ts_min_date"]=as.Date(airbnbData[,which(colnames(airbnbData)=="ts_min_calc")])
airbnbData[,"ts_max_date"]=as.Date(airbnbData[,which(colnames(airbnbData)=="ts_max_calc")])
airbnbData[,"sameday_check"]=ifelse(airbnbData$ts_min_date==airbnbData$ts_max_date,0,1)

startDate=as.Date(min(airbnbData$ts_min_calc))
endDate=as.Date(max(airbnbData$ts_max_calc))



#Analysis by Visitors
ActivitybyVisitor = group_by(airbnbData, id_visitor) %>% summarise(count_id = count(id_visitor))

#Activity by visitor
countVisitor = c(ActivitybyVisitor[,1])
ActivitybyVisitor[,"visitor_id"] = as.character(countVisitor$x)
ActivitybyVisitor[,"count_id"] = countVisitor$freq
ActivitybyVisitor[,"countid"] = byVisitor$count_id
ActivitybyVisitor$count_id=NULL
colnames(ActivitybyVisitor) = c("visitor_id", "count_id")


#Time per Visitor
TimebyVisitor = aggregate.data.frame(airbnbData$ts_diff, by = list(airbnbData$id_visitor), FUN = sum)
TimeVisitor = c(TimebyVisitor)
TimebyVisitor[,"visitor_id"] = as.character(TimeVisitor$Group.1)
TimebyVisitor[, "visitor_duration"] = TimeVisitor$x
TimebyVisitor$Group.1 = NULL
TimebyVisitor$x = NULL


#merging by visitor data
byVisitor = join(ActivitybyVisitor, TimebyVisitor)



ActivitybyDate = group_by(airbnbData, ts_min_date) %>% summarise(count = count(ts_min_date))
#byDate[,"date"] = sort(unique(airbnbData$ts_min_date), decreasing = FALSE)
rownames(ActivitybyDate) = c(sort(unique(airbnbData$ts_min_date), decreasing = FALSE))

countDate = c(ActivitybyDate[,1])
ActivitybyDate[,"date"] = as.Date(rownames(ActivitybyDate))
ActivitybyDate[,"visits1"]=countDate$freq
ActivitybyDate[,1] = NULL

#Unique visitors per day
UVbyDate = aggregate.data.frame(airbnbData$id_visitor, by = list(airbnbData$ts_min_date), FUN = count)

TimebyDate = aggregate.data.frame(airbnbData$ts_diff, by = list(airbnbData$ts_min_date), FUN = sum)
colnames(TimebyDate) = c("date", "duration1")

Date=as.data.frame(as.Date(c(startDate:endDate), origin = "1970-01-01"))
rownames(Date) = c(as.Date(c(startDate:endDate), origin = "1970-01-01"))
colnames(Date) = c("date")


byDate = join(Date, ActivitybyDate)
byDate[,"visits"] = NAer(byDate$visits1, replace = 0)
byDate[,"visits1"] = NULL
byDate = join(byDate, TimebyDate)
byDate[,"duration2"] = as.numeric(byDate$duration1)
byDate[,"duration"] = NAer(byDate$duration2, replace = 0)
byDate[,"duration1"] = NULL
byDate[,"duration2"] = NULL
byDate[,"daily_avg_dur"] = byDate$duration / byDate$visits / 60
byDate[,"daily_avg_duration"]=NAer(byDate$daily_avg_dur, replace = 0)
byDate[,"daily_avg_dur"] = NULL

ggplot(byDate, mapping = aes(x = byDate$date, y = byDate$visits)) + geom_area()
ggplot(byDate, mapping = aes(x = byDate$date, y = byDate$duration)) + geom_area()
```


##LiLin
Frequency of sessions by month:
```{r, echo=FALSE, message=FALSE, prompt=FALSE, results='asis'}
#chooseCRANmirror(ind=1)
airbnbdata = read_excel("../data/Airbnb_data.xlsx")
dates <- airbnbdata[,"ds"]
dates <- as.matrix(dates)
#dates <- as.Date.POSIXct(dates)
dates_m <- month(dates)
dates_m <- t(t(dates_m))

hist(dates_m, breaks= 0:13, col="lightblue", labels=TRUE, xlim=c(0,12), ylim=c(0,1400), xlab="Month (1=Jan etc)")
library(ggplot2)
#qplot(dates_m, geom="histogram", binwidth=1)
```

<br>
Frequency of sessions by day of week (based on start time):
```{r, echo=FALSE, message=FALSE, prompt=FALSE, results='asis'}
dates_day <- wday(dates, label=T)
dates_day <- t(t(dates_day))

dat <- as.Date(dates)
Dayofweek_a <- format(dat , "%a")   #day of week
Dayofweek <- as.numeric( format(dat , "%w") ) # numeric version of day of week
hist(Dayofweek , breaks= -.5+0:7, labels= unique(Dayofweek_a[order(Dayofweek)]))
```

<br>
Frequency of sessions by hour of day:
```{r, echo=FALSE, message=FALSE, prompt=FALSE, results='asis'}
dates_min <- airbnbdata[,"ts_min"]
dates_min <- as.matrix(dates_min)
dates_h <- hour(dates_min)
dates_h[dates_h==0] <- 24
dates_h <- t(t(dates_h))
dates_h_forhist <- dates_h + 1
dates_h_forhist[dates_h_forhist==2] <- 1.5

hist(dates_h_forhist, breaks=24, col="lightblue", labels=TRUE, xlim=c(0,25), ylim=c(0,750), xaxt="n", main="Number of sessions by hour of day")
axis(side=1, at=seq(0,25,1), labels=seq(0,25,1))
#qplot(dates_h, geom="histogram", binwidth=1)
```
<br>

And number of sessions by hour-blocks during the day:
```{r, echo=FALSE, message=FALSE, prompt=FALSE, results='asis'}
hist(dates_h_forhist, breaks=5, col="lightblue", labels=TRUE, xlim=c(1,25), ylim=c(0,3000), xaxt="n", main="Number of sessions by hour-blocks of the day")
axis(side=1, at=seq(1,25,1), labels=seq(1,25,1))

```

<br>


<br>

This is the distribution of session duration in minutes:
```{r, echo=FALSE, message=FALSE, prompt=FALSE, results='asis'}
airbnbdata$ts_diff <- airbnbdata$ts_max - airbnbdata$ts_min
airbnbdata$ts_diff <- airbnbdata$ts_diff / 60
airbnbdata$ts_diff <- as.numeric(airbnbdata$ts_diff)
bins <- c(seq(-10,1000,10))
hist(airbnbdata$ts_diff, labels=TRUE, main="Distribution of session duration (min)", col="lightblue", breaks=bins, xlim=c(-10,200), ylim=c(0,6000))
```

<br>

This is the distribution of total time spent by each user in one day (minutes):
```{r, echo=FALSE, message=FALSE, prompt=FALSE, results='asis'}

airbnbdata$id_ds <- paste(airbnbdata$id_visitor,airbnbdata$ds)
airbnbdata$flag <- 1

time_user_day <-  group_by(airbnbdata, id_ds) %>% summarise(time = sum(ts_diff))
bins <- c(seq(-10,10000,10))
hist(time_user_day$time, labels=TRUE, main="Disbribution of total time spent per day by each user",col="lightblue", breaks=bins, xlim=c(-10,200), ylim=c(0,2500), xaxt="n", xlab="Total mins spent on Airbnb per day")
axis(side=1, at=seq(-10,200,10), labels=seq(-10,200,10))
```

<br>
<br>

Below we see the relationship between time of day and booking. 
It is interesting to see that the percentage in May appears to be unusally high. Perhaps this is being driven by easier search processes, which may be caused by a greater abundance of available Airbnb rooms. On the contrary this may be caused by a difference in price sensitivity of users during this month. Further data and analysis to assess the underlying drivers of this difference would be interesting as a next step, and may lead to some insights for how to improve the efficiency and ease of the user experience.

<br>
```{r, echo=FALSE, message=FALSE, prompt=FALSE, results='asis'}
df_cor <- data.frame(dates_m, dates_h, airbnbdata$did_search, airbnbdata$sent_message, airbnbdata$sent_booking_request)
df_by_m_book <- df_cor %>% group_by(dates_m) %>% summarise(Sent_booking_request=sum(airbnbdata.sent_booking_request==1), No_booking_request=sum(airbnbdata.sent_booking_request==0))
df_by_m_book$Total_sessions <- df_by_m_book$Sent_booking_request + df_by_m_book$No_booking_request
df_by_m_book$Visit_to_booking_percentage <- df_by_m_book$Sent_booking_request / df_by_m_book$Total_sessions

plot(df_by_m_book$Visit_to_booking_percentage, type="o", main="% of booking requests to total visits, by month", ylab="% bookings to visits", xlab="Month", xaxt="n")
axis(side=1, at=seq(0,12,1), labels=c("","Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"))
```


<br>

##Shiksha

First, let's look at the data

```{r, echo=FALSE, message=FALSE, prompt=FALSE, results='asis'}
#local_directory=getwd()
#source(paste("../R/library.R"))
#airbnbData = read.csv(paste(local_directory,"data/Airbnb_data1.csv", sep="/"), header=TRUE, sep=",", dec=".")
#library(googleVis)
#t1 <- gvisTable(airbnbdata[,],options = list(showRowNumber = FALSE, width = 800, height = min(400,27*(nrow(airbnbdata) + 1)), allowHTML = TRUE, page = 'disable'))
#print(t1,'chart')
```

## Introductory analysis


##
Number of visits per booking
```{r echo=TRUE, eval=TRUE, tidy=TRUE}
airbnb_visits = nrow(airbnbData)
class(airbnbData)
Visitsperbooking=nrow(airbnbData)/sum(airbnbData$sent_booking_request)
```

For Looking at Desktop bookings with Chrome

```{r echo=TRUE, eval=TRUE, tidy=TRUE}
airbnb_visits_Chrome = airbnbData[airbnbData$dim_device_app_combo =="Desktop - Chrome", ]
airbnb_bookings_Chrome = sum(airbnb_visits_Chrome$sent_booking_request)
Visit_per_booking_Chrome = nrow(airbnb_visits_Chrome)/airbnb_bookings_Chrome
```

Number of messages per booking
```{r echo=TRUE, eval=TRUE, tidy=TRUE}
messagesperbooking=sum(airbnbdata$sent_message)/sum(airbnbData$sent_booking_request)
```

For Looking at Desktop bookings with Chrome
Number of message per booking

```{r echo=TRUE, eval=TRUE, tidy=TRUE}
airbnb_visits_Chrome = airbnbData[airbnbData$dim_device_app_combo =="Desktop - Chrome", ]
airbnb_bookings_Chrome = sum(airbnb_visits_Chrome$sent_booking_request)
message_per_booking_Chrome = sum(airbnb_visits_Chrome$sent_message)/airbnb_bookings_Chrome
```

Number of searches per booking
```{r echo=TRUE, eval=TRUE, tidy=TRUE}
searchesperbooking=sum(airbnbData$did_search)/sum(airbnbData$sent_booking_request)
```

For Looking at Desktop bookings with Chrome
Number of searches per booking

```{r echo=TRUE, eval=TRUE, tidy=TRUE}
airbnb_visits_Chrome = airbnbData[airbnbData$dim_device_app_combo =="Desktop - Chrome", ]
airbnb_bookings_Chrome = sum(airbnb_visits_Chrome$sent_booking_request)
search_per_booking_Chrome = sum(airbnb_visits_Chrome$did_search)/airbnb_bookings_Chrome
```
